<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Management - Employment Payroll System</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <h2>Employment Payroll System</h2>
        </div>
        <div class="nav-links">
            <a href="dashboard.html" class="nav-link">Dashboard</a>
            <a href="employees.html" class="nav-link active">Employees</a>
            <a href="payroll.html" class="nav-link">Payroll</a>
        </div>
        <div class="nav-user">
            <span id="welcomeUser">Welcome, Admin</span>
            <button id="logoutBtn" class="btn btn-secondary">Logout</button>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1>Employee Management</h1>
            <button id="addEmployeeBtn" class="btn btn-primary">Add New Employee</button>
        </div>

        <div class="search-section">
            <input type="text" id="searchInput" placeholder="Search employees by name or department..." class="search-input">
            <button id="searchBtn" class="btn btn-secondary">Search</button>
            <button id="clearSearchBtn" class="btn btn-tertiary">Clear</button>
        </div>

        <div class="employees-section">
            <div class="table-container">
                <table id="employeesTable" class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Department</th>
                            <th>Basic Salary</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="employeesTableBody">
                        <!-- Employee data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <div id="loadingSpinner" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Loading employees...</p>
        </div>

        <div id="noEmployees" class="no-data" style="display: none;">
            <h3>No Employees Found</h3>
            <p>Click "Add New Employee" to get started.</p>
        </div>
    </div>

    <!-- Add/Edit Employee Modal -->
    <div id="employeeModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add New Employee</h2>
                <span class="close" id="closeModal">&times;</span>
            </div>
            <form id="employeeForm">
                <div class="form-group">
                    <label for="employeeName">Employee Name:</label>
                    <input type="text" id="employeeName" name="name" required>
                </div>
                
                <div class="form-group">
                    <label for="employeeDepartment">Department:</label>
                    <select id="employeeDepartment" name="department" required>
                        <option value="">Select Department</option>
                        <option value="Engineering">Engineering</option>
                        <option value="Marketing">Marketing</option>
                        <option value="HR">HR</option>
                        <option value="Finance">Finance</option>
                        <option value="Sales">Sales</option>
                        <option value="Operations">Operations</option>
                        <option value="IT">IT</option>
                        <option value="Customer Service">Customer Service</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="employeeSalary">Basic Salary:</label>
                    <input type="number" id="employeeSalary" name="basic_salary" min="0" step="0.01" required>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Employee</button>
                    <button type="button" id="cancelBtn" class="btn btn-secondary">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Confirm Delete</h2>
                <span class="close" id="closeDeleteModal">&times;</span>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this employee?</p>
                <p><strong id="deleteEmployeeName"></strong></p>
                <p class="warning">This action cannot be undone and will also delete all associated payroll records.</p>
            </div>
            <div class="form-actions">
                <button id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
                <button id="cancelDeleteBtn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div id="messageContainer" class="message-container" style="display: none;">
        <div id="messageContent" class="message"></div>
    </div>

    <script src="script.js"></script>
    <script>
        // Check authentication
        checkAuthentication();

        // Set welcome message
        const username = localStorage.getItem('username') || 'Admin';
        document.getElementById('welcomeUser').textContent = `Welcome, ${username}`;

        // Global variables
        let employees = [];
        let editingEmployeeId = null;
        let deletingEmployeeId = null;

        // DOM elements
        const addEmployeeBtn = document.getElementById('addEmployeeBtn');
        const employeeModal = document.getElementById('employeeModal');
        const deleteModal = document.getElementById('deleteModal');
        const employeeForm = document.getElementById('employeeForm');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        const logoutBtn = document.getElementById('logoutBtn');

        // Event listeners
        addEmployeeBtn.addEventListener('click', () => openEmployeeModal());
        document.getElementById('closeModal').addEventListener('click', closeEmployeeModal);
        document.getElementById('closeDeleteModal').addEventListener('click', closeDeleteModal);
        document.getElementById('cancelBtn').addEventListener('click', closeEmployeeModal);
        document.getElementById('cancelDeleteBtn').addEventListener('click', closeDeleteModal);
        employeeForm.addEventListener('submit', saveEmployee);
        searchBtn.addEventListener('click', searchEmployees);
        clearSearchBtn.addEventListener('click', clearSearch);
        logoutBtn.addEventListener('click', logout);
        document.getElementById('confirmDeleteBtn').addEventListener('click', deleteEmployee);

        // Search functionality
        searchInput.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                searchEmployees();
            }
        });

        // Load employees on page load
        loadEmployees();

        async function loadEmployees() {
            showLoading(true);
            try {
                const response = await fetch('http://localhost:8080/api/employees');
                employees = await response.json();
                displayEmployees(employees);
            } catch (error) {
                showMessage('Error loading employees: ' + error.message, 'error');
                console.error('Error:', error);
            } finally {
                showLoading(false);
            }
        }

        function displayEmployees(employeesToShow) {
            const tbody = document.getElementById('employeesTableBody');
            const noEmployeesDiv = document.getElementById('noEmployees');
            
            if (employeesToShow.length === 0) {
                tbody.innerHTML = '';
                noEmployeesDiv.style.display = 'block';
                return;
            }
            
            noEmployeesDiv.style.display = 'none';
            tbody.innerHTML = employeesToShow.map(employee => `
                <tr>
                    <td>${employee.id}</td>
                    <td>${employee.name}</td>
                    <td>${employee.department}</td>
                    <td>$${employee.basic_salary.toFixed(2)}</td>
                    <td class="actions">
                        <button onclick="editEmployee(${employee.id})" class="btn btn-small btn-primary">Edit</button>
                        <button onclick="confirmDeleteEmployee(${employee.id}, '${employee.name}')" class="btn btn-small btn-danger">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function openEmployeeModal(employee = null) {
            editingEmployeeId = employee ? employee.id : null;
            document.getElementById('modalTitle').textContent = employee ? 'Edit Employee' : 'Add New Employee';
            
            if (employee) {
                document.getElementById('employeeName').value = employee.name;
                document.getElementById('employeeDepartment').value = employee.department;
                document.getElementById('employeeSalary').value = employee.basic_salary;
            } else {
                employeeForm.reset();
            }
            
            employeeModal.style.display = 'flex';
        }

        function closeEmployeeModal() {
            employeeModal.style.display = 'none';
            editingEmployeeId = null;
            employeeForm.reset();
        }

        function editEmployee(employeeId) {
            const employee = employees.find(emp => emp.id === employeeId);
            if (employee) {
                openEmployeeModal(employee);
            }
        }

        function confirmDeleteEmployee(employeeId, employeeName) {
            deletingEmployeeId = employeeId;
            document.getElementById('deleteEmployeeName').textContent = employeeName;
            deleteModal.style.display = 'flex';
        }

        function closeDeleteModal() {
            deleteModal.style.display = 'none';
            deletingEmployeeId = null;
        }

        async function saveEmployee(e) {
            e.preventDefault();
            
            const formData = new FormData(employeeForm);
            const employeeData = new URLSearchParams();
            for (let [key, value] of formData.entries()) {
                employeeData.append(key, value);
            }
            
            try {
                let url = 'http://localhost:8080/api/employees';
                let method = 'POST';
                
                if (editingEmployeeId) {
                    url = `http://localhost:8080/api/employee/${editingEmployeeId}`;
                    method = 'PUT';
                }
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: employeeData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    closeEmployeeModal();
                    loadEmployees();
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('Error saving employee: ' + error.message, 'error');
                console.error('Error:', error);
            }
        }

        async function deleteEmployee() {
            if (!deletingEmployeeId) return;
            
            try {
                const response = await fetch(`http://localhost:8080/api/employee/${deletingEmployeeId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    closeDeleteModal();
                    loadEmployees();
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('Error deleting employee: ' + error.message, 'error');
                console.error('Error:', error);
            }
        }

        function searchEmployees() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            if (!searchTerm) {
                displayEmployees(employees);
                return;
            }
            
            const filteredEmployees = employees.filter(employee => 
                employee.name.toLowerCase().includes(searchTerm) ||
                employee.department.toLowerCase().includes(searchTerm)
            );
            
            displayEmployees(filteredEmployees);
        }

        function clearSearch() {
            searchInput.value = '';
            displayEmployees(employees);
        }

        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
        }

        function showMessage(message, type = 'info') {
            const container = document.getElementById('messageContainer');
            const content = document.getElementById('messageContent');
            
            content.textContent = message;
            content.className = `message ${type}`;
            container.style.display = 'block';
            
            setTimeout(() => {
                container.style.display = 'none';
            }, 5000);
        }

        // Close modals when clicking outside
        window.addEventListener('click', function(e) {
            if (e.target === employeeModal) {
                closeEmployeeModal();
            }
            if (e.target === deleteModal) {
                closeDeleteModal();
            }
        });
    </script>
</body>
</html>